.. _cameras:

*****************************
Управление видеокамерами
*****************************

Для настройки видео-идентификации лиц добавьте камеры в FindFace Security, сгруппировав их c учетом расположения.

.. rubric:: В этой главе:

.. contents::
   :local:


Создание группы камер
============================

Для создания группы камер выполните следующие действия:

#. В веб-интерфейсе перейдите на вкладку :guilabel:`Группы камер`.

    |create_camera_group_ru|

     .. |create_camera_group_ru| image:: /_static/create_camera_group.png
        :scale: 60%

     .. |create_camera_group_en| image:: /_static/create_camera_group_en.png
        :scale: 60%

#. Нажмите на кнопку :guilabel:`Создать`.
#. Введите имя группы и при необходимости комментарий к ней.
#. Если видео с группы камер требуется обрабатывать в определенном экземпляре компонента ``video-worker``, создайте или выберите из уже созданных одну или несколько меток для привязки группы камер к экземпляру.

   .. note::
      Привязка выполняется через файл конфигурации ``video-worker`` (см. :ref:`video-allocation`).

#. Если события от камер, принадлежащих одной группе, требуется дедуплицировать, т. е. исключить одинаковые события, поставьте флажок :guilabel:`Дедуплицировать события` и задайте в секундах интервал дедупликации (интервал, с которым события проверяются на уникальность).
#. Поставьте флажок :guilabel:`Активная`.

     |camera_group_ru|

     .. |camera_group_ru| image:: /_static/camera_group.png
        :scale: 80%

     .. |camera_group_en| image:: /_static/camera_group_en.png
        :scale: 80%

#. Нажмите на кнопку :guilabel:`Сохранить`.


Добавление камеры в группу
====================================

Для добавления камеры в группу выполните следующие действия:

#. В веб-интерфейсе перейдите на вкладку :guilabel:`Камеры`.

     |create_camera_ru|

     .. |create_camera_ru| image:: /_static/create_camera.png
        :scale: 60%

     .. |create_camera_en| image:: /_static/create_camera_en.png
        :scale: 60%


#. Нажмите на кнопку :guilabel:`Добавить`.
#. Введите название камеры и добавьте ее в одну из групп. При необходимости введите комментарий к камере.

     |camera_ru|

     .. |camera_ru| image:: /_static/camera.png
        :scale: 80%

     .. |camera_en| image:: /_static/camera_en.png
        :scale: 80%


#. Задайте URL камеры или адрес видеофайла для обработки.
 
#. Поставьте флажок :guilabel:`Активная`.
#. Если вы используете версию FindFace Security с обработкой видео на CPU, нажмите на кнопку :guilabel:`Параметры` и перейдите на вкладку :guilabel:`CPU`.
  
   * ``Min face quality``: Минимальное качество изображения лица при выборе лучшего. Определяется эмпирически: отрицательные значения вблизи 0 = наиболее качественные прямые изображения лиц анфас, -1 = хорошее качество, -2 = удовлетворительное качество, отрицательные значения -5 и меньше = перевернутые лица и лица, повернутые под большими углами, распознавание может быть неэффективным.
   * ``Max face angle``: Максимальное отклонение лица от положения анфас при выборе лучшего. Определяется эмпирически: -3.5 = слишком большие углы поворота, распознавание лиц может быть неэффективным,  -2.5 = удовлетворительное отклонение, -0.05 = близко к положению анфас, 0 = анфас.
   * ``Min face size``: Минимальный размер лица в пикселях при выборе лучшего. Чем меньше значение, тем дольше осуществляется обнаружение и отслеживание лиц. Оптимальное значение: 80-100-120. Если 0, фильтр выключен.
   * ``Max face size``: Максимальный размер лица в пикселях при выборе лучшего. Если 0, фильтр выключен.
   * ``Realtime mode``: Режим реального времени. Выбирать лучший кадр с лицом в каждом интервале времени ``Snapshot picking interval``. Если ``Post each best snapshot: true``, отправка лучшего кадра происходит по завершению каждого интервала ``Snapshot picking interval``; если ``false``, лучший кадр отправляется, только если его качество улучшилось по сравнению с предыдущим отправленным кадром.
   * ``Post each best snapshot``: Если ``true``, отправлять лучший кадр в каждом интервале времени ``Snapshot picking interval`` в режиме реального времени. Если ``false``, отправлять лучший кадр, только если его качество улучшилось по сравнению с предыдущим отправленным кадром.
   * ``Snapshot picking interval``: Временной интервал в миллисекундах, в течение которого в режиме реального времени выбирается лучший кадр с лицом.
   * ``Offline mode``: Буферный режим. Отправлять для лица один кадр наилучшего качества.
   * ``ROT``: Детектирование и отслеживание лиц только внутри заданной прямоугольной области. Используйте данную опцию, чтобы уменьшить нагрузку на видеодетектор лиц.
   * ``ROI``: Отправка в компонент ``ffsecurity`` только тех лиц, которые были обнаружены внутри интересующей области.

     .. |roi_rot_ru| image:: /_static/roi_rot.png
        :scale: 70%

     .. |roi_rot_en| image:: /_static/roi_rot_en.png
        :scale: 70%

     .. tip::
        Для задания ROT/ROI удобно использовать визуальный мастер. Сначала создайте камеру без ROT/ROI, затем откройте ее для редактирования и нажмите на кнопку :guilabel:`Параметры`. Вы увидите визуальный мастер.

#. При необходимости задайте опциональные параметры обработки видео на CPU. Для это нажмите на кнопку :guilabel:`Дополнительные параметры`.

   * ``FFMPEG options``: Опции ffmpeg для видеопотока. Задаются массивом строк ключ-значение, например, ``["rtsp_transpotr=tcp", "ss=00:20:00"]``.
   * ``Frame height``: Размер кадра для детектора лиц в пикселях. Отрицательные значения соответствуют исходному размеру. Оптимальные значения для уменьшения нагрузки: 640-720.
   * ``Tracked faces``: Максимальное количество лиц, одновременно отслеживаемых детектором лиц. Влияет на производительность.
   * ``Tracker threads``: Количество тредов отслеживания для детектора лиц. Должно быть меньше или равно значению параметра npersons. Оптимально, когда они равны. Если количество тредов отслеживания меньше, чем максимальное количество отслеживаемых лиц, потребление ресурсов уменьшается, однако также уменьшается и скорость отслеживания.
   * ``JPEG quality``: Качество сжатия полного кадра для отправки.
   * ``Draw track``: Рисовать в bbox след от движения лица.
   * ``Response timeout``: Время ожидания в миллисекундах ответа на API-запрос.
   * ``Min motion intensity``: Минимальная интенсивность движения, которая будет регистрироваться детектором движения. Определяется эмпирически: 0 = детектор выключен, 0.002 = значение по умолчанию, 0.05 = минимальная интенсивность слишком высока, чтобы зарегистрировать движение.
   * ``Scale frame``: Размер кадра для детектора движения относительно исходного размера от 0 до 1. Кадр должен быть уменьшен при больших разрешениях камеры, отображении лиц крупным планом, а также при чрезмерной загрузке процессора — для снижения потребления системных ресурсов.

#. Если вы используете версию FindFace Security с обработкой видео на GPU, нажмите на кнопку :guilabel:`Параметры` и перейдите на вкладку :guilabel:`GPU`.
  
   * ``Filter min face quality``: Минимальное качество изображения лица для отправки на сервер. Определяется эмпирически: отрицательные значения вблизи 0 = наиболее качественные прямые изображения лиц анфас, -1 = хорошее качество, -2 = удовлетворительное качество, отрицательные значения -5 и меньше = перевернутые лица и лица, повернутые под большими углами, распознавание может быть неэффективным.
   * ``Min face size``: Минимальный размер лица в пикселях для отправки на сервер. Если 0, фильтр выключен.
   * ``Max face size``: Максимальный размер лица в пикселях для отправки на сервер.
   * ``Min face size``: Минимальный размер лица в пикселях для отправки на сервер. Если 0, фильтр выключен.
   * ``JPEG quality``: Качество сжатия полного кадра для отправки.
   * ``FFMPEG options``: Опции ffmpeg для видеопотока. Задаются массивом строк ключ-значение, например, ``["rtsp_transpotr=tcp", "ss=00:20:00"]``.
   * ``Post only the best snapshot``: Буферный режим. Отправлять для лица один кадр наилучшего качества.
   * ``Posting timeout``: Время ожидания в миллисекундах ответа на отправленный запрос с лицом.
   * ``Retrieve timestamps from stream``: Если ``true``, отправлять на сервер временные метки из потока. Если ``false``, отправлять текущие дату и время.
   * ``Add to timestamp``: Прибавлять указанное количество секунд к временным меткам из потока.
 
#. Нажмите на кнопку :guilabel:`Сохранить`.

Мониторинг работы камер
==============================

Мониторинг работы камер выполняется на вкладке :guilabel:`Камеры`. 

     |monitor_cameras_ru|

     .. |monitor_cameras_ru| image:: /_static/monitor_cameras.png
        :scale: 60%

     .. |monitor_cameras_en| image:: /_static/monitor_cameras_en.png
        :scale: 60%


Статусы камер:

* Зеленый: идет обработка видеопотока с камеры, проблем не обнаружено.
* Желтый: камера работает менее 30 секунд или имеют место ошибки при отправке лиц.
* Красный: камера не работает.

Для каждой камеры приводятся следующие статистические данные по обработке видеопотока: длительность обработки/количество успешно отправленных лиц/количество лиц, обработанных с ошибками.

Для перезапуска камеры нажмите на кнопку :guilabel:`Перезапустить` в столбце :guilabel:`Состояние`.

При большом количестве камер в системе используйте следующие фильтры:

* :guilabel:`Группа камер`,
* :guilabel:`Активная`,
* :guilabel:`Статус`.
